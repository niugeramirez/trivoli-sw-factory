<%
'==================================================================
'	include para crear his_estructura para Situacion Revista
'==================================================================
	Dim l_estrnro
	Dim l_estrnroant
	Dim l_htetdesde 
	Dim l_htethasta 
	Dim l_fechacierre 
	Dim l_fechasig
	Dim l_fechacierreant
	Dim l_fechasigant
	
	Dim x_cm
	Dim x_sql
    Dim l_desdeanterior 
    Dim l_hastaanterior 
	
	'buscar las fechas anteriores para controlar his_estructura
	function buscarfechasanteriores()
	
		Set m_rs = Server.CreateObject("ADODB.RecordSet")
		m_sql = "SELECT * FROM emp_lic "
		m_sql = m_sql & " where emp_licnro = " & l_emp_licnro
		rsOpen m_rs, cn, m_sql, 0 
		if not m_rs.eof then
			l_desdeanterior = cambiafecha(m_rs("elfechadesde"),"","")
			l_hastaanterior = cambiafecha(m_rs("elfechahasta"),"","")
		end if
		m_rs.close
		
	end function 'buscarfechasanteriores

	l_htetdesde = cambiafecha(l_elfechadesde,"YMD",true) 
	l_htethasta = cambiafecha(l_elfechahasta,"YMD",true)
	l_fechacierre = cambiafecha(DateAdd("d",-1,cDate(l_elfechadesde)),"YMD",true)
	l_fechasig    = cambiafecha(DateAdd("d",1 ,cDate(l_elfechahasta)),"YMD",true)
	
	l_estrnro =""
	Set m_rs = Server.CreateObject("ADODB.RecordSet")
	x_sql = "SELECT estrnro, tdnro "
	x_sql = x_sql & "FROM csijp_srtd "
	x_sql = x_sql & "WHERE tdnro = " & l_tdnro
	rsOpen m_rs, cn, x_sql, 0 
	if not m_rs.eof then
		l_estrnro = m_rs("estrnro") 
	end if	
	m_rs.Close
	
	if request.queryString("tipo") = "A" then
    
			if trim(l_estrnro)<>"" then

				'2) cerrar la his_estructura existente si EXISTE -----------------------

				x_sql = "UPDATE his_estructura SET "
				x_sql = x_sql & " htethasta = " & l_fechacierre
				x_sql = x_sql & " WHERE tenro = 30 " 
				x_sql = x_sql & " AND   ternro = " & l_empleado 
				x_sql = x_sql & " AND   htethasta IS NULL " 
				'No hay que controlar por la estructura, por que no se sabe cual es la anterior
				'x_sql = x_sql & " AND   estrnro= " & l_estrnro 
				set x_cm = Server.CreateObject("ADODB.Command")
				x_cm.activeconnection = Cn
				x_cm.CommandText = x_sql
				cmExecute x_cm, x_sql, 0
				
			'3) Crear el his_estructura para la licencia --------------------------------------------
				x_sql = "INSERT INTO his_estructura "
				x_sql = x_sql & " (tenro, ternro, estrnro, htetdesde,htethasta) "
				x_sql = x_sql & " VALUES (30, " & l_empleado & ", " 
				x_sql = x_sql & l_estrnro   & ", " 
				x_sql = x_sql & l_htetdesde & ", " 
				x_sql = x_sql & l_htethasta & ")"
				set x_cm = Server.CreateObject("ADODB.Command")
				x_cm.activeconnection = Cn
				x_cm.CommandText = x_sql
				cmExecute x_cm, x_sql, 0
				
			'4) Crear en el his_estructura una situacion de revista activo --------------------------------------------
				x_sql = "INSERT INTO his_estructura "
				x_sql = x_sql & " (tenro, ternro, estrnro, htetdesde,htethasta) "
				x_sql = x_sql & " VALUES (30, " & l_empleado & ", " 
				x_sql = x_sql & "1, " 
				x_sql = x_sql & l_fechasig & ", " 
				x_sql = x_sql & "null)"
				set x_cm = Server.CreateObject("ADODB.Command")
				x_cm.activeconnection = Cn
				x_cm.CommandText = x_sql
				cmExecute x_cm, x_sql, 0
				
			end if
	
	else ' modi
  	    buscarfechasanteriores()
		
	    l_fechacierreant = cambiafecha(DateAdd("d",-1,cDate(l_desdeanterior)),"YMD",true)
	    l_fechasigant    = cambiafecha(DateAdd("d",1 ,cDate(l_hastaanterior)),"YMD",true)
	
		'si cambio el tdnro controlo que tenga asociada una SitRevista
		if CInt(l_tdnro) <> CInt(l_tdnroant) then
			'Response.Write("<script>alert('distintos tdnro');</script>")
			l_estrnroant =""
			Set m_rs = Server.CreateObject("ADODB.RecordSet")
			x_sql = "SELECT estrnro, tdnro "
			x_sql = x_sql & "FROM csijp_srtd "
			x_sql = x_sql & "WHERE tdnro = " & l_tdnroant
			rsOpen m_rs, cn, x_sql, 0 
			if not m_rs.eof then
				l_estrnroant = m_rs("estrnro") 
			end if	
			m_rs.Close
		
			' tenia asociada una sit.revista
			if trim(l_estrnroant) <>"" then
				'Response.Write("<script>alert('estrnroant NO vacio');</script>")
				'Response.Write("<script>alert('"&l_estrnro&"');</script>")
				'Response.Write("<script>alert('"&l_estrnroant&"');</script>")
		
				if trim(l_estrnro)<>"" then ' le cambio la estructura
					x_sql = "UPDATE  his_estructura SET"
					x_sql = x_sql & " estrnro = " & l_estrnro	  & ","
					x_sql = x_sql & " htetdesde = " & l_htetdesde & ","
					x_sql = x_sql & " htethasta = " & l_htethasta
					x_sql = x_sql & " WHERE tenro   = 30 " 
					x_sql = x_sql & " AND   estrnro = " & l_estrnroant
					x_sql = x_sql & " AND   ternro  = " & l_empleado
					x_sql = x_sql & " AND   htetdesde  = " & l_desdeanterior
					x_sql = x_sql & " AND   htethasta  = " & l_hastaanterior
					set x_cm = Server.CreateObject("ADODB.Command")
					x_cm.activeconnection = Cn
					x_cm.CommandText = x_sql
					cmExecute x_cm, x_sql, 0
				else ' la actual no tiene, tengo que borra el reg. de his_estructura
					x_sql = "DELETE FROM his_estructura "
					x_sql = x_sql & " WHERE estrnro = " & l_estrnroant
					x_sql = x_sql & " AND   tenro   = 30 " 
					x_sql = x_sql & " AND   ternro  = " & l_empleado
					x_sql = x_sql & " AND   htetdesde  = " & l_desdeanterior
					x_sql = x_sql & " AND   htethasta  = " & l_hastaanterior
					set x_cm = Server.CreateObject("ADODB.Command")
					x_cm.activeconnection = Cn
					x_cm.CommandText = x_sql
					cmExecute x_cm, x_sql, 0
					
					'Como lo borre tengo que abrir la fecha anterior
					x_sql = "UPDATE  his_estructura SET"
					x_sql = x_sql & " htethasta = null " 
					x_sql = x_sql & " WHERE tenro   = 30 " 
					x_sql = x_sql & " AND   ternro  = " & l_empleado
					x_sql = x_sql & " AND   htethasta  = " & l_fechacierreant 
					set x_cm = Server.CreateObject("ADODB.Command")
					x_cm.activeconnection = Cn
					x_cm.CommandText = x_sql
					cmExecute x_cm, x_sql, 0
					
				end if ' si tiene nuueva estructura 
			else ' no tenia estructura asociada. 
				if trim(l_estrnro)<>"" then ' y ahora tiene. Inserto.
					'Response.Write("<script>alert('estrnro con algo');</script>")
					x_sql = "INSERT INTO his_estructura ( "
					x_sql = x_sql & " estrnro, tenro,ternro,htetdesde,htethasta)"
					x_sql = x_sql & " VALUES ("
					x_sql = x_sql & l_estrnro   & ",30,"
					x_sql = x_sql & l_empleado  & ","
					x_sql = x_sql & l_htetdesde & ","
					x_sql = x_sql & l_htethasta & ")"
					set x_cm = Server.CreateObject("ADODB.Command")
					x_cm.activeconnection = Cn
					x_cm.CommandText = x_sql
					cmExecute x_cm, x_sql, 0
				end if
			end if
		
		else ' no cambio el tipo dia
		 ' ver si cambio fechas		
		 'Response.Write("<script>alert('NO CAMBIO TIPO DIA');</script>")
	
			x_sql = "UPDATE  his_estructura SET"
			x_sql = x_sql & " htetdesde = " & l_htetdesde & ","
			x_sql = x_sql & " htethasta = " & l_htethasta
			x_sql = x_sql & " WHERE tenro   = 30 " 
			x_sql = x_sql & " AND   estrnro = " & l_estrnro
			x_sql = x_sql & " AND   ternro  = " & l_empleado
			x_sql = x_sql & " AND   htetdesde  = " & l_desdeanterior
			x_sql = x_sql & " AND   htethasta  = " & l_hastaanterior
			set x_cm = Server.CreateObject("ADODB.Command")
			x_cm.activeconnection = Cn
			x_cm.CommandText = x_sql
			cmExecute x_cm, x_sql, 0

		end if 'si cambio el tipo dia
		
		'Actualizo la estructura anterior
		x_sql = "UPDATE  his_estructura SET"
		x_sql = x_sql & " htethasta = " & l_fechacierre 
		x_sql = x_sql & " WHERE tenro   = 30 " 
		x_sql = x_sql & " AND   ternro  = " & l_empleado
		x_sql = x_sql & " AND   htethasta  = " & l_fechacierreant 
		set x_cm = Server.CreateObject("ADODB.Command")
		x_cm.activeconnection = Cn
		x_cm.CommandText = x_sql
		cmExecute x_cm, x_sql, 0
		
		'Actualizo la estructura posterior
		x_sql = "UPDATE  his_estructura SET"
		x_sql = x_sql & " htetdesde = " & l_fechasig
		x_sql = x_sql & " WHERE tenro   = 30 " 
		x_sql = x_sql & " AND   ternro  = " & l_empleado
		x_sql = x_sql & " AND   htetdesde  = " & l_fechasigant 
		set x_cm = Server.CreateObject("ADODB.Command")
		x_cm.activeconnection = Cn
		x_cm.CommandText = x_sql
		cmExecute x_cm, x_sql, 0
		

		
	end if ' alta/modi
	' FIN DEL INCLUDE	  
	'===========================================================================
	%>